{% extends "base.html" %}

{% block title %}{{ _('Catalogue') }}{% if request.args.get('brand') %} — {{ request.args.get('brand') }}{% endif %} — Kitaly Archive{% endblock %}

{% block head %}
<link rel="canonical" href="{{ url_for('public.catalog', _external=True) }}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 lg:px-12 py-12">
    <div class="mb-16 animate-slide-up">
        <h1 class="font-display font-bold text-5xl lg:text-6xl tracking-tight text-slate-900 mb-4">
            {{ _('Catalogue') }}<span class="text-italy-600">.</span>
        </h1>
        <p class="text-slate-500 text-lg max-w-2xl leading-relaxed">
            {{ _("Explore our curated collection of iconic football heritage, spanning decades of history and passion.")
            }}
        </p>
    </div>

    <div class="flex flex-col lg:flex-row gap-12 lg:items-start">

        <aside class="w-full lg:w-80 flex-shrink-0 animate-slide-up" style="animation-delay: 0.1s">
            <div class="sticky top-28">
                <button id="catalog-filters-toggle" type="button"
                    class="lg:hidden w-full inline-flex items-center justify-between rounded-full border border-slate-200 bg-white/80 px-5 py-3 text-xs font-bold uppercase tracking-widest text-slate-600 shadow-sm">
                    <span id="catalog-filters-toggle-text">{{ _('Show filters') }}</span>
                    <i id="catalog-filters-toggle-icon" data-lucide="chevron-down"
                        class="w-4 h-4 transition-transform duration-200"></i>
                </button>

                <div id="catalog-filters-panel" class="hidden lg:block mt-8 lg:mt-0 lg:max-h-[calc(100vh-9rem)] lg:overflow-y-auto lg:pr-3">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="font-display font-semibold text-xl tracking-tight">{{ _('Filters') }}</h2>
                        <a href="{{ url_for('public.catalog') }}"
                            class="text-[10px] font-bold uppercase tracking-widest text-italy-600 hover:text-italy-700 transition-colors">
                            {{ _('Reset') }}
                        </a>
                    </div>

                    <form action="{{ url_for('public.catalog') }}" method="GET" class="space-y-10">
                        <div class="relative group">
                            <i data-lucide="search"
                                class="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-italy-600 transition-colors"></i>
                            <input type="text" name="q" value="{{ request.args.get('q', '') }}"
                                placeholder="{{ _('Search...') }}"
                                class="w-full pl-7 py-2 bg-transparent border-b border-slate-200 focus:border-italy-600 outline-none text-sm transition-all">
                        </div>

                        <div class="space-y-8">
                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Brand') }}</label>
                                <select name="brand"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Brands') }}</option>
                                    {% for b in brands %}
                                    <option value="{{ b }}" {% if request.args.get('brand')==b %}selected{% endif %}>{{ b }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Team') }}</label>
                                <select name="squadra"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Teams') }}</option>
                                    {% for sq in squadre %}
                                    <option value="{{ sq }}" {% if request.args.get('squadra')==sq %}selected{% endif %}>{{
                                        sq }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Team Type') }}</label>
                                <label class="inline-flex items-center gap-3 text-sm text-slate-600">
                                    <input type="checkbox" name="nazionale" value="1"
                                        class="h-4 w-4 rounded border-slate-300 text-italy-600 focus:ring-italy-600"
                                        {% if request.args.get('nazionale') %}checked{% endif %}>
                                    <span>{{ _('National Team') }}</span>
                                </label>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Player Issue') }}</label>
                                <label class="inline-flex items-center gap-3 text-sm text-slate-600">
                                    <input type="checkbox" name="player_issued" value="1"
                                        class="h-4 w-4 rounded border-slate-300 text-italy-600 focus:ring-italy-600"
                                        {% if request.args.get('player_issued') %}checked{% endif %}>
                                    <span>{{ _('Player Issue') }}</span>
                                </label>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Player') }}</label>
                                <select name="player_name"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Players') }}</option>
                                    {% for pn in player_names %}
                                    <option value="{{ pn }}" {% if request.args.get('player_name')==pn %}selected{% endif %}>
                                        {{ pn }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('League') }}</label>
                                <select name="campionato"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Leagues') }}</option>
                                    {% for league in campionati %}
                                    <option value="{{ league }}" {% if request.args.get('campionato')==league %}selected{%
                                        endif %}>{{ league }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Type') }}</label>
                                <select name="type"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Types') }}</option>
                                    {% for t in types %}
                                    <option value="{{ t }}" {% if request.args.get('type')==t %}selected{% endif %}>{{
                                        t|type_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Shirt Feature') }}</label>
                                <select name="tipologia"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Features') }}</option>
                                    {% for t in tipologie %}
                                    <option value="{{ t }}" {% if request.args.get('tipologia')==t %}selected{% endif %}>
                                        {{ t|feature_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Sleeve Type') }}</label>
                                <select name="maniche"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Sleeve Types') }}</option>
                                    {% for m in maniche_values %}
                                    <option value="{{ m }}" {% if request.args.get('maniche')==m %}selected{% endif %}>
                                        {{ m|sleeve_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Season') }}</label>
                                <select name="stagione"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Seasons') }}</option>
                                    {% for s in stagioni %}
                                    <option value="{{ s }}" {% if request.args.get('stagione')==s %}selected{% endif %}>{{ s
                                        }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-4">{{
                                    _('Size') }}</label>
                                <select name="taglia"
                                    class="w-full py-2 bg-transparent border-b border-slate-200 text-sm focus:border-italy-600 outline-none cursor-pointer">
                                    <option value="">{{ _('All Sizes') }}</option>
                                    {% for t in taglie %}
                                    <option value="{{ t }}" {% if request.args.get('taglia')==t %}selected{% endif %}>{{ t
                                        }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="pt-2 flex gap-3">
                            <button type="submit"
                                class="flex-1 inline-flex items-center justify-center rounded-full bg-slate-900 px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-white hover:bg-italy-600 transition-colors">
                                {{ _('Apply') }}
                            </button>
                            <a href="{{ url_for('public.catalog') }}"
                                class="inline-flex items-center justify-center rounded-full border border-slate-200 px-5 py-3 text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-italy-600 hover:border-italy-100 transition-colors">
                                {{ _('Reset') }}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </aside>

        <div class="flex-1 animate-slide-up" style="animation-delay: 0.2s">
            <div class="flex justify-between items-center mb-10">
                <p class="text-xs font-medium text-slate-400 italic">
                    {{ shirts.total }} {{ _('items discovered') }}
                </p>
                <form action="{{ url_for('public.catalog') }}" method="GET" class="flex items-center gap-3">
                    <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">{{ _('Sort by')
                        }}</span>
                    <select name="sort"
                        class="text-xs font-semibold text-slate-900 bg-transparent outline-none cursor-pointer focus:text-italy-600 transition-colors"
                        onchange="this.form.submit()">
                        <option value="newest" {% if request.args.get('sort', 'newest')=='newest' %}selected{% endif %}>{{
                            _('Latest Arrival') }}</option>
                        <option value="oldest" {% if request.args.get('sort')=='oldest' %}selected{% endif %}>{{
                            _('Timeline') }}</option>
                        <option value="random" {% if request.args.get('sort')=='random' %}selected{% endif %}>{{
                            _('Random') }}</option>
                    </select>
                    {% for key, values in request.args.lists() %}
                    {% if key not in ['sort', 'page', 'seed'] %}
                    {% for value in values %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                    {% if request.args.get('sort') == 'random' and shuffle_seed %}
                    <input type="hidden" name="seed" value="{{ shuffle_seed }}">
                    {% endif %}
                </form>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-2 xl:grid-cols-3 gap-x-4 sm:gap-x-8 gap-y-10 sm:gap-y-16">
                {% for shirt in shirts.items %}
                <a href="{{ url_for('public.shirt_detail', shirt_id=shirt.id, slug=shirt|shirt_slug_localized) }}"
                    class="group block">
                    <div
                        class="relative aspect-[4/5] overflow-hidden rounded-[2rem] bg-slate-100 transition-all duration-700 group-hover:shadow-[0_40px_80px_-20px_rgba(0,0,0,0.1)]">
                        {% if shirt.images %}
                        {% set active_image_id = shirt.cover_image.id if shirt.cover_image else shirt.images[0].id %}
                        <div class="h-full w-full relative" data-gallery style="touch-action: pan-y;">
                            {% for img in shirt.images %}
                            <img src="{{ url_for('uploaded_file', filename=img.file_path) }}"
                                alt="{{ shirt|team_name_localized }}"
                                data-gallery-image
                                class="absolute inset-0 h-full w-full object-cover transition-transform duration-1000 group-hover:scale-110 {% if img.id != active_image_id %}hidden{% endif %}">
                            {% endfor %}
                            {% if shirt.images|length > 1 %}
                            <div
                                class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-2 py-1 rounded-full bg-black/15 backdrop-blur-sm pointer-events-none">
                                {% for img in shirt.images %}
                                <span data-gallery-dot
                                    class="h-1.5 w-1.5 rounded-full {% if img.id == active_image_id %}bg-white{% else %}bg-white/40{% endif %}"></span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="flex h-full w-full items-center justify-center text-slate-300">
                            <i data-lucide="shirt" class="w-12 h-12 stroke-[1.5]"></i>
                        </div>
                        {% endif %}

                        <div
                            class="absolute top-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-2 group-hover:translate-y-0">
                            <span
                                class="px-3 py-1.5 bg-white/80 backdrop-blur-md rounded-full text-[10px] font-bold uppercase tracking-widest shadow-sm">
                                {{ shirt.brand }}
                            </span>
                        </div>
                    </div>

                    <div class="mt-8 px-2">
                        <div class="space-y-1">
                            <h3
                                class="font-display font-semibold text-lg tracking-tight text-slate-900 group-hover:text-italy-600 transition-colors leading-snug">
                                {{ shirt|display_name_localized }}
                                {% if shirt.player_issued %}
                                <span class="inline-flex align-middle ml-1 text-amber-500" aria-label="{{ _('Player Issue') }}">
                                    <i data-lucide="star" class="w-3 h-3 fill-current player-issue-star player-issue-star-title"></i>
                                </span>
                                {% endif %}
                            </h3>
                            {% if shirt.player_issued %}
                            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-amber-50 text-amber-600 text-[10px] font-bold uppercase tracking-widest">
                                <i data-lucide="star" class="w-3 h-3 fill-current"></i>
                                {{ _('Player Issue') }}
                                <button type="button" onclick="openPlayerIssueInfoCatalog()"
                                    class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/80 text-amber-600 hover:bg-white transition-colors"
                                    aria-label="{{ _('About Player Issue') }}">
                                    <i data-lucide="info" class="w-3 h-3"></i>
                                </button>
                            </div>
                            {% endif %}
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">{{
                                    shirt|competition_label_localized }}</span>
                                <div class="h-1 w-1 rounded-full bg-slate-200"></div>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-italy-600">({{
                                    shirt.taglia }})</span>
                            </div>
                        </div>
                    </div>
                </a>
                {% else %}
                <div
                    class="col-span-full py-32 text-center bg-slate-50 rounded-[3rem] border-2 border-dashed border-slate-100">
                    <div
                        class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-white shadow-sm text-slate-300 mb-8">
                        <i data-lucide="search-x" class="w-10 h-10 stroke-[1]"></i>
                    </div>
                    <h3 class="font-display font-semibold text-2xl text-slate-900 mb-3">{{ _('Nothing matches') }}</h3>
                    <p class="text-slate-400 mb-10">{{ _('Our scouts couldn\'t find any match for your current
                        selection.') }}</p>
                    <a href="{{ url_for('public.catalog') }}"
                        class="inline-flex py-4 px-10 bg-premium-slate text-white rounded-full font-bold text-sm hover:bg-italy-600 transition-all shadow-lg shadow-slate-200/50 active:scale-95">
                        {{ _('Explore All') }}
                    </a>
                </div>
                {% endfor %}
            </div>

            {% if shirts.pages > 1 %}
            <nav class="mt-14 flex items-center justify-center gap-3" aria-label="Pagination">
                {% if shirts.has_prev %}
                <a href="{{ catalog_url_for(page=shirts.prev_num) }}"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 hover:border-italy-100 hover:text-italy-600 transition-colors">
                    {{ _('Previous') }}
                </a>
                {% endif %}

                <span class="text-xs font-semibold text-slate-400">
                    {{ _('Page') }} {{ shirts.page }} / {{ shirts.pages }}
                </span>

                {% if shirts.has_next %}
                <a href="{{ catalog_url_for(page=shirts.next_num) }}"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 hover:border-italy-100 hover:text-italy-600 transition-colors">
                    {{ _('Next') }}
                </a>
                {% endif %}
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<div id="player-issue-info-modal-catalog"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 backdrop-blur-sm px-6">
    <div class="w-full max-w-lg rounded-[2rem] bg-white shadow-2xl border border-slate-100/70 p-8">
        <div class="flex items-start justify-between gap-6 mb-4">
            <h3 class="font-display font-semibold text-xl text-slate-900">{{ _('Player Issue') }}</h3>
            <button type="button" onclick="closePlayerIssueInfoCatalog()"
                class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:text-slate-900 hover:bg-slate-200 transition-colors"
                aria-label="{{ _('Close') }}">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <p class="text-slate-600 leading-relaxed text-sm">
            {{ _('Player Issue (or Staff issue) means an item that was not sold commercially and was produced specifically for the squad, making them one of the rarest and most sought after pieces in the football world!') }}
        </p>
        <div class="mt-6 flex justify-end">
            <button type="button" onclick="closePlayerIssueInfoCatalog()"
                class="inline-flex items-center justify-center px-5 py-2.5 rounded-xl bg-slate-900 text-white text-xs font-bold uppercase tracking-widest hover:bg-italy-600 transition-colors">
                {{ _('Got it') }}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('catalog-filters-toggle');
        const panel = document.getElementById('catalog-filters-panel');
        const text = document.getElementById('catalog-filters-toggle-text');
        const icon = document.getElementById('catalog-filters-toggle-icon');

        if (toggle && panel && text && icon) {
            const showLabel = "{{ _('Show filters') }}";
            const hideLabel = "{{ _('Hide filters') }}";

            const setExpanded = (expanded) => {
                toggle.setAttribute('aria-expanded', String(expanded));
                text.textContent = expanded ? hideLabel : showLabel;
                icon.classList.toggle('rotate-180', expanded);
            };

            setExpanded(false);

            toggle.addEventListener('click', () => {
                const isHidden = panel.classList.contains('hidden');
                if (isHidden) {
                    panel.classList.remove('hidden');
                    setExpanded(true);
                } else {
                    panel.classList.add('hidden');
                    setExpanded(false);
                }
            });
        }

        document.querySelectorAll('[data-gallery]').forEach((gallery) => {
            const images = Array.from(gallery.querySelectorAll('[data-gallery-image]'));
            if (images.length < 2) {
                return;
            }

            const dots = Array.from(gallery.querySelectorAll('[data-gallery-dot]'));
            const link = gallery.closest('a');
            let currentIndex = images.findIndex((img) => !img.classList.contains('hidden'));
            let startX = 0;
            let deltaX = 0;
            let dragged = false;
            let hoverInterval = null;

            if (currentIndex < 0) {
                currentIndex = 0;
            }
            const initialIndex = currentIndex;

            const setSlide = (nextIndex) => {
                currentIndex = (nextIndex + images.length) % images.length;
                images.forEach((img, index) => {
                    img.classList.toggle('hidden', index !== currentIndex);
                });
                dots.forEach((dot, index) => {
                    dot.classList.toggle('bg-white', index === currentIndex);
                    dot.classList.toggle('bg-white/40', index !== currentIndex);
                });
            };

            const stopHoverPreview = () => {
                if (hoverInterval !== null) {
                    window.clearInterval(hoverInterval);
                    hoverInterval = null;
                }
            };

            const startHoverPreview = () => {
                if (!window.matchMedia('(hover: hover) and (pointer: fine)').matches || hoverInterval !== null) {
                    return;
                }
                let previewIndex = 0;
                setSlide(previewIndex);
                hoverInterval = window.setInterval(() => {
                    previewIndex = (previewIndex + 1) % images.length;
                    setSlide(previewIndex);
                }, 800);
            };

            const preventFollow = () => {
                if (!link) {
                    return;
                }
                link.dataset.swipePreventClick = '1';
                window.setTimeout(() => {
                    delete link.dataset.swipePreventClick;
                }, 250);
            };

            gallery.addEventListener('touchstart', (event) => {
                if (!event.touches.length) {
                    return;
                }
                startX = event.touches[0].clientX;
                deltaX = 0;
                dragged = false;
            }, { passive: true });

            gallery.addEventListener('touchmove', (event) => {
                if (!event.touches.length) {
                    return;
                }
                deltaX = event.touches[0].clientX - startX;
                if (Math.abs(deltaX) > 12) {
                    dragged = true;
                }
            }, { passive: true });

            gallery.addEventListener('touchend', () => {
                if (Math.abs(deltaX) > 40) {
                    setSlide(currentIndex + (deltaX < 0 ? 1 : -1));
                    preventFollow();
                } else if (dragged) {
                    preventFollow();
                }
                deltaX = 0;
                dragged = false;
            });

            gallery.addEventListener('mouseenter', startHoverPreview);
            gallery.addEventListener('mouseleave', () => {
                stopHoverPreview();
                setSlide(initialIndex);
            });

            if (link) {
                link.addEventListener('click', (event) => {
                    if (link.dataset.swipePreventClick === '1') {
                        event.preventDefault();
                    }
                });
            }
        });
    });

    function openPlayerIssueInfoCatalog() {
        const modal = document.getElementById('player-issue-info-modal-catalog');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }
    function closePlayerIssueInfoCatalog() {
        const modal = document.getElementById('player-issue-info-modal-catalog');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }
</script>
{% endblock %}
